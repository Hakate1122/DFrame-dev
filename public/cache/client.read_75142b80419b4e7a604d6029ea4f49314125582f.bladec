<!DOCTYPE html>
<html lang="vi">

<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <title>Đọc Truyện - Website Truyện</title>
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
 <style>
 body {
 background-color: #f8f8f8;
 }

 .reader-container {
 max-width: 800px;
 margin: auto;
 background: #fff;
 padding: 15px;
 box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
 }

 .chapter-title {
 font-size: 20px;
 font-weight: bold;
 margin-bottom: 15px;
 text-align: center;
 word-break: break-word;
 }

 .chapter-content {
 font-size: 14px;
 word-break: break-word;
 }
 .chapter-content p {
 text-align: justify;
 line-height: 1.7;
 margin-bottom: 15px;
 }

 .chapter-nav {
 margin-top: 20px;
 text-align: center;
 }

 @media (max-width: 480px) {
 .reader-container {
 padding: 6px;
 }
 .chapter-title {
 font-size: 16px;
 }
 .chapter-content {
 font-size: 14px;
 }
 .chapter-content p {
 line-height: 1.5;
 }
 #font-control-form label,
 #font-control-form select,
 #font-control-form input,
 #font-control-form button {
 font-size: 13px;
 }
 #audiobook-alert {
 font-size: 11px;
 min-width: 90px;
 padding: 4px 6px;
 margin-bottom: 8px;
 }
 }

 @media (max-width: 240px) {
 .reader-container {
 padding: 2px;
 }
 .chapter-title {
 font-size: 12px;
 margin-bottom: 6px;
 }
 .chapter-content {
 font-size: 10px;
 }
 #font-control-form label,
 #font-control-form select,
 #font-control-form input,
 #font-control-form button {
 font-size: 10px;
 }
 #audiobook-alert {
 font-size: 9px;
 min-width: 60px;
 padding: 2px 3px;
 margin-bottom: 4px;
 }
 }

 @media (max-width: 180px) {
 #audiobook-alert {
 display: none !important;
 }
 }
 @media (max-width: 160px) {
 .reader-container {
 padding: 0;
 }
 .chapter-title {
 font-size: 9px;
 }
 .chapter-content {
 font-size: 7px;
 }
 #audiobook-alert {
 font-size: 7px;
 min-width: 30px;
 padding: 1px 2px;
 }
 }

 @media (min-width: 1920px) {
 .reader-container {
 max-width: 1200px;
 padding: 32px;
 }
 .chapter-title {
 font-size: 32px;
 }
 .chapter-content {
 font-size: 22px;
 }
 #font-control-form label,
 #font-control-form select,
 #font-control-form input,
 #font-control-form button {
 font-size: 20px;
 }
 #audiobook-alert {
 font-size: 18px;
 min-width: 240px;
 padding: 14px 24px;
 }
 }
 </style>
</head>

<body>
 <nav class="navbar navbar-inverse">
 <div class="container-fluid">
 <div class="navbar-header">
 <a class="navbar-brand" href="<?= route("client.welcome") ?>">DocTruyen</a>
 </div>
 <ul class="nav navbar-nav">
 <li><a href="<?= route('client.welcome') ?>">Trang chủ</a></li>
 <li><a href="<?= route('client.category') ?>">Thể loại</a></li>
 <li><a href="<?= route('client.newest') ?>">Mới cập nhật</a></li>
 </ul>
 </div>
 </nav>

 <div class="container reader-container">
 <!-- Alert cố định báo không hỗ trợ Audiobook đặt phía trên -->
 <div class="alert alert-warning" id="audiobook-alert" style="position:relative; right:auto; bottom:auto; min-width:180px; max-width:90vw; z-index:9999; padding:8px 16px; font-size:13px; box-shadow:0 2px 8px #0002; margin-bottom:12px; text-align:left; display:inline-block;">
 <span class="glyphicon glyphicon-volume-off" style="margin-right:6px;"></span>
 Truyện hoặc thiết bị không hỗ trợ Audiobook.
 </div>
 <!-- Thanh điều khiển font và cỡ chữ -->
 <form id="font-control-form" class="form-inline" style="margin-bottom:18px; text-align:center;">
 <div class="form-group">
 <label for="font-family-select">Phông chữ:</label>
 <select id="font-family-select" class="form-control" style="min-width:120px">
 <option value="">Mặc định</option>
 <option value="Arial,Helvetica,sans-serif">Arial</option>
 <option value="'Times New Roman',Times,serif">Times New Roman</option>
 <option value="Roboto,sans-serif">Roboto</option>
 <option value="'Comic Sans MS',cursive,sans-serif">Comic Sans MS</option>
 </select>
 </div>
 <div class="form-group" style="margin-left:12px;">
 <label for="font-size-range">Cỡ chữ:</label>
 <input type="range" id="font-size-range" min="12" max="32" value="14" step="1" style="vertical-align:middle; width:100px">
 <span id="font-size-value" style="display:inline-block; min-width:28px;">14px</span>
 </div>
 <button type="submit" class="btn btn-primary" style="margin-left:12px;">Xác nhận</button>
 </form>
 <?php
 $chapterInfo = Source::check('comic1.txt', true);
 $chapterFile = is_array($chapterInfo) && isset($chapterInfo['path']) ? $chapterInfo['path'] : null;
 $chapterTitle = '';
 $chapterParagraphs = [];
 if ($chapterFile && file_exists($chapterFile)) {
 $content = file_get_contents($chapterFile);
 // Tách tiêu đề chương (dòng đầu có thể bắt đầu bằng # hoặc Chương)
 if (preg_match('/^#?Chương\s*\d+\s*[:：-]?\s*(.*)$/mi', $content, $matches)) {
 $chapterTitle = trim($matches[0]);
 }
 // Tách đoạn văn (bỏ tiêu đề nếu có)
 $content = preg_replace('/^#?Chương\s*\d+\s*[:：-]?.*$/mi', '', $content, 1);
 // Tách các đoạn dựa trên 2 dòng xuống dòng hoặc dòng trống
 $chapterParagraphs = preg_split('/\r?\n\s*\r?\n/', trim($content));
 }
 ?>
 <h1 class="chapter-title"><?php echo $chapterTitle ?: 'Chương truyện'; ?></h1>
 <div class="chapter-content">
 <?php if (!empty($chapterParagraphs)): ?>
 <?php foreach ($chapterParagraphs as $para): ?>
 <p><?= nl2br(htmlspecialchars(trim($para))) ?></p>
 <?php endforeach; ?>
 <?php else: ?>
 <p>Không tìm thấy nội dung chương.</p>
 <?php endif; ?>
 </div>

 <div class="chapter-nav">
 <a href="#" class="btn btn-default">← Chương trước</a>
 <a href="#" class="btn btn-default">Chương sau →</a>
 </div>
 </div>

 <footer class="text-center" style="margin-top:30px; padding:15px; background:#222; color:#aaa;">
 <p>© 2025 Website Truyện. All rights reserved.</p>
 </footer>


 <style>
 @media (max-width: 340px) {
 #audiobook-alert { font-size:11px; min-width:100px; padding:6px 8px; }
 }
 </style>

 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
 <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

 <script>
 // Khôi phục lựa chọn từ localStorage
 function applyFontSettings() {
 var font = localStorage.getItem('reader_font_family') || '';
 var size = localStorage.getItem('reader_font_size') || '14';
 if (font) {
 document.querySelector('.chapter-content').style.fontFamily = font;
 document.getElementById('font-family-select').value = font;
 } else {
 document.querySelector('.chapter-content').style.fontFamily = '';
 document.getElementById('font-family-select').value = '';
 }
 document.querySelector('.chapter-content').style.fontSize = size + 'px';
 document.getElementById('font-size-range').value = size;
 document.getElementById('font-size-value').textContent = size + 'px';
 }

 // Cập nhật hiển thị giá trị cỡ chữ khi kéo
 document.getElementById('font-size-range').addEventListener('input', function() {
 document.getElementById('font-size-value').textContent = this.value + 'px';
 });

 // Xử lý xác nhận
 document.getElementById('font-control-form').addEventListener('submit', function(e) {
 e.preventDefault();
 var font = document.getElementById('font-family-select').value;
 var size = document.getElementById('font-size-range').value;
 if (font) {
 document.querySelector('.chapter-content').style.fontFamily = font;
 localStorage.setItem('reader_font_family', font);
 } else {
 document.querySelector('.chapter-content').style.fontFamily = '';
 localStorage.removeItem('reader_font_family');
 }
 document.querySelector('.chapter-content').style.fontSize = size + 'px';
 localStorage.setItem('reader_font_size', size);
 });

 // Áp dụng khi tải trang
 applyFontSettings();
 </script>
</body>

</html>