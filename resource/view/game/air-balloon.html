<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Khí Cầu - Pro Edition</title>
    <style>
        /* CSS hỗ trợ Chrome 30+ (Dùng tiền tố -webkit-) */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #ffffff;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            -webkit-user-select: none; /* Cũ cho Chrome 30 */
            user-select: none;
        }

        #game-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 500px; /* Giới hạn chiều rộng cho Desktop để giống Mobile */
            margin: 0 auto;
            background: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* UI Styling */
        .score-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            display: -webkit-box; display: -webkit-flex; display: flex;
            -webkit-box-pack: justify; -webkit-justify-content: space-between; justify-content: space-between;
            padding: 20px; box-sizing: border-box;
            color: #666; font-size: 16px; pointer-events: none;
        }

        #game-over {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            display: none; /* Hiện khi thua */
            -webkit-box-orient: vertical; -webkit-box-direction: normal; 
            -webkit-flex-direction: column; flex-direction: column;
            -webkit-box-pack: center; -webkit-justify-content: center; justify-content: center;
            -webkit-box-align: center; -webkit-align-items: center; align-items: center;
            z-index: 100;
        }

        .btn-play {
            background: #5f6368; color: #fff; border: none;
            padding: 15px 50px; border-radius: 4px; font-size: 16px;
            margin-top: 30px; cursor: pointer;
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="canvas"></canvas>
    
    <div class="score-bar">
        <div id="currentScore">0</div>
        <div>XIN CHÀO <span id="highScoreText">188</span></div>
        <div style="opacity:0.5">||</div>
    </div>

    <div id="game-over">
        <h1 style="color:#666; text-align:center; font-weight:normal; letter-spacing:2px;">
            TRÒ CHƠI KẾT<br>THÚC
        </h1>
        <button class="btn-play" onclick="resetGame()">CHƠI LẠI</button>
        <p style="margin-top:20px; color:#999; font-size:12px;" onclick="location.reload()">THOÁT</p>
    </div>
</div>

<script>
    // --- KHỞI TẠO BIẾN (ES5 thuần túY) ---
    var cvs = document.getElementById("canvas");
    var ctx = cvs.getContext("2d");
    var scoreLabel = document.getElementById("currentScore");
    var highLabel = document.getElementById("highScoreText");
    var overScreen = document.getElementById("game-over");

    var w, h, ratio;
    var gameActive = false;
    var score = 0;
    var highScore = localStorage.getItem("ballon_highscore") || 188;

    // Cấu hình vật thể
    var balloon = { x: 0, y: 0, r: 18 };
    var bubbles = [];
    var spikes = [];
    var speed = 3.5;
    var spawnTimer = 0;

    function init() {
        // Responsive chuẩn: Tính toán theo tỉ lệ màn hình
        w = cvs.width = cvs.offsetWidth;
        h = cvs.height = cvs.offsetHeight;
        balloon.x = w / 2;
        balloon.y = h * 0.75;
        highLabel.innerHTML = highScore;
        
        // Input: Chrome 30 hỗ trợ TouchEvents tốt
        cvs.addEventListener("touchstart", moveHandler, false);
        cvs.addEventListener("touchmove", moveHandler, false);
        cvs.addEventListener("mousemove", moveHandler, false);
        
        resetGame();
    }

    function moveHandler(e) {
        if (!gameActive) return;
        var clientX = e.clientX || (e.touches && e.touches[0].clientX);
        var rect = cvs.getBoundingClientRect();
        var targetX = clientX - rect.left;
        // Lerp mượt mà (Hỗ trợ tốt từ senior perspective)
        balloon.x += (targetX - balloon.x) * 0.15; 
        e.preventDefault();
    }

    // --- LOGIC GAME ---

    function createSpike() {
        var gap = 100;
        var width = 70 + Math.random() * 60;
        spikes.push({
            x: Math.random() * (w - width),
            y: -20,
            w: width,
            h: 10
        });
    }

    function createBubble() {
        bubbles.push({
            x: Math.random() * w,
            y: -10,
            r: 7 // Bong bóng nhỏ hơn và bằng nhau theo yêu cầu
        });
    }

    function update() {
        if (!gameActive) return;

        spawnTimer++;
        if (spawnTimer % 80 === 0) createSpike();
        if (spawnTimer % 50 === 0) createBubble();

        // Update Gai
        for (var i = spikes.length - 1; i >= 0; i--) {
            spikes[i].y += speed;
            // Va chạm Gai (AABB simplified)
            if (balloon.x + 10 > spikes[i].x && balloon.x - 10 < spikes[i].x + spikes[i].w &&
                balloon.y > spikes[i].y && balloon.y < spikes[i].y + 25) {
                gameOver();
            }
            if (spikes[i].y > h) spikes.splice(i, 1);
        }

        // Update Bong bóng
        for (var j = bubbles.length - 1; j >= 0; j--) {
            bubbles[j].y += speed;
            // Va chạm tròn (Euclidean distance)
            var dx = balloon.x - bubbles[j].x;
            var dy = balloon.y - bubbles[j].y;
            if (Math.sqrt(dx*dx + dy*dy) < balloon.r + bubbles[j].r) {
                score++;
                scoreLabel.innerHTML = score;
                bubbles.splice(j, 1);
            } else if (bubbles[j].y > h) {
                bubbles.splice(j, 1);
            }
        }
        
        if (score % 20 === 0 && score > 0) speed += 0.005; // Khó dần
    }

    function draw() {
        ctx.clearRect(0, 0, w, h);

        // Vẽ Khí cầu (Styling theo ảnh 2)
        ctx.fillStyle = "#5f6368";
        ctx.beginPath();
        ctx.arc(balloon.x, balloon.y, balloon.r, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillRect(balloon.x - 6, balloon.y + 22, 12, 10); // Giỏ

        // Vẽ Gai
        ctx.fillStyle = "#666";
        for (var i = 0; i < spikes.length; i++) {
            var s = spikes[i];
            ctx.fillRect(s.x, s.y, s.w, 3);
            for (var j = 0; j < s.w; j += 8) {
                ctx.beginPath();
                ctx.moveTo(s.x + j, s.y + 3);
                ctx.lineTo(s.x + j + 4, s.y + 12);
                ctx.lineTo(s.x + j + 8, s.y + 3);
                ctx.fill();
            }
        }

        // Vẽ Bong bóng
        ctx.strokeStyle = "#666";
        ctx.lineWidth = 1;
        for (var k = 0; k < bubbles.length; k++) {
            var b = bubbles[k];
            ctx.beginPath();
            ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
            ctx.stroke();
            // Highlight
            ctx.beginPath();
            ctx.arc(b.x - 2, b.y - 2, 1.5, 0, Math.PI * 2);
            ctx.fillStyle = "#999"; ctx.fill();
        }

        requestAnimationFrame(draw);
    }

    function gameOver() {
        gameActive = false;
        if (score > highScore) {
            highScore = score;
            localStorage.setItem("ballon_highscore", highScore);
            highLabel.innerHTML = highScore;
        }
        overScreen.style.display = "-webkit-box";
        overScreen.style.display = "-webkit-flex";
        overScreen.style.display = "flex";
    }

    function resetGame() {
        score = 0;
        speed = 3.5;
        scoreLabel.innerHTML = "0";
        spikes = [];
        bubbles = [];
        gameActive = true;
        overScreen.style.display = "none";
    }

    // Start
    init();
    draw();
    setInterval(update, 1000/60); // Đảm bảo logic chạy đều ngay cả khi rAF bị drop frame ở máy cũ

</script>
</body>
</html>